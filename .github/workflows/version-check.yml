# Version Validation Workflow
# Ensures version consistency and prevents unauthorized version bumps
#
# Rules:
# 1. Root package.json version must match .release-please-manifest.json
# 2. Version changes only allowed in release-please PRs
# 3. Prevents manual version bumps in regular PRs

name: Version Check

on:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  version-consistency:
    name: Check Version Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Extract version from package.json
        id: pkg_version
        run: |
          PKG_VERSION=$(jq -r '.version' package.json)
          echo "pkg_version=$PKG_VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ package.json version: $PKG_VERSION"

      - name: Extract version from release-please manifest
        id: manifest_version
        run: |
          MANIFEST_VERSION=$(jq -r '."."' .release-please-manifest.json)
          echo "manifest_version=$MANIFEST_VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Release Please Manifest: $MANIFEST_VERSION"

      - name: Validate version consistency
        run: |
          if [ "${{ steps.pkg_version.outputs.pkg_version }}" != "${{ steps.manifest_version.outputs.manifest_version }}" ]; then
            echo "‚ùå Version mismatch detected!"
            echo ""
            echo "package.json: ${{ steps.pkg_version.outputs.pkg_version }}"
            echo "Manifest (.release-please-manifest.json): ${{ steps.manifest_version.outputs.manifest_version }}"
            echo ""
            echo "These versions MUST match!"
            echo "Version changes should only happen through Release Please."
            exit 1
          fi
          echo "‚úÖ Version consistency validated: ${{ steps.pkg_version.outputs.pkg_version }}"

  prevent-manual-bump:
    name: Prevent Manual Version Bumps
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Skip for Release Please PRs (detected by title pattern or branch name)
    if: >-
      !contains(github.event.pull_request.title, 'chore: Release')
      && !contains(github.event.pull_request.title, 'release')
      && !startsWith(github.head_ref, 'release-please--')
    steps:
      - name: Checkout base branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.base_ref }}

      - name: Get base version
        id: base_version
        run: |
          BASE_VERSION=$(jq -r '.version' package.json)
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Base version: $BASE_VERSION"

      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Get PR version
        id: pr_version
        run: |
          PR_VERSION=$(jq -r '.version' package.json)
          echo "pr_version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ PR version: $PR_VERSION"

      - name: Check for unauthorized version bump
        run: |
          if [ "${{ steps.base_version.outputs.base_version }}" != "${{ steps.pr_version.outputs.pr_version }}" ]; then
            echo "‚ùå Unauthorized version bump detected!"
            echo ""
            echo "Base version: ${{ steps.base_version.outputs.base_version }}"
            echo "PR version: ${{ steps.pr_version.outputs.pr_version }}"
            echo ""
            echo "‚ö†Ô∏è  Version bumps are only allowed in Release Please PRs!"
            echo ""
            echo "Versions should only change when:"
            echo "  ‚Ä¢ Release Please creates an automated release PR"
            echo "  ‚Ä¢ The PR title starts with 'chore: Release'"
            echo ""
            echo "For regular development PRs:"
            echo "  ‚Ä¢ Keep package.json version unchanged"
            echo "  ‚Ä¢ Use conventional commits (feat:, fix:, etc.)"
            echo "  ‚Ä¢ Release Please will handle versioning automatically"
            exit 1
          fi
          echo "‚úÖ No unauthorized version changes detected"
