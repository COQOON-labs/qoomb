name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - uses: wagoid/commitlint-github-action@baa1b236f990293a1b2d94c19e41c2313a85e749 # v6.0.2
        with:
          configFile: commitlint.config.mjs

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/dependency-review-action@05fe4576374b728f0c523d6a13d64c25081e0803 # v4.8.3
        with:
          # Block PRs that introduce new HIGH or CRITICAL vulnerabilities.
          # License compliance is handled separately in the quality job via pnpm licenses list.
          fail-on-severity: high

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm run db:generate
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost/dummy

      - name: Security audit
        # Fail CI on HIGH or CRITICAL vulnerabilities.
        # MODERATE/LOW are visible in the output but do not block merging —
        # they are usually transitive dependencies with no upstream fix yet.
        # The npm audit endpoint occasionally returns 500 — retry once, then
        # warn instead of failing CI on transient registry outages.
        run: |
          pnpm audit --audit-level high || {
            exit_code=$?
            if [ $exit_code -eq 1 ]; then
              # exit 1 from pnpm audit = found vulnerabilities → fail CI
              exit 1
            else
              # Other exit codes (e.g. network/registry errors) → warn only
              echo "::warning::pnpm audit failed with exit code $exit_code (likely a registry issue). Skipping."
            fi
          }

      - name: License compliance check
        run: |
          pnpm licenses list --json 2>/dev/null | node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('/dev/stdin', 'utf8'));

            // Licenses incompatible with Qoomb's Fair Source / commercial dual-license
            const banned = ['GPL-2.0', 'GPL-3.0', 'AGPL-3.0', 'AGPL-1.0', 'SSPL-1.0', 'EUPL-1.1', 'EUPL-1.2'];
            const violations = [];

            for (const [license, pkgs] of Object.entries(data)) {
              if (banned.some(b => license.toUpperCase().includes(b.toUpperCase()))) {
                violations.push({ license, packages: pkgs.map(p => p.name) });
              }
            }

            if (violations.length) {
              console.error('❌ Banned licenses found:');
              for (const v of violations) {
                console.error('  ' + v.license + ': ' + v.packages.join(', '));
              }
              process.exit(1);
            }
            console.log('✅ All ' + Object.keys(data).length + ' licenses compliant');
          "

      - name: Lint
        run: pnpm run lint

      - name: Format check
        run: pnpm run format:check

      - name: Type check
        run: pnpm run type-check

      - name: Build
        run: pnpm run build

  test:
    name: Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: pgvector/pgvector:pg18
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: qoomb_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:8
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm run db:generate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/qoomb_test

      - name: Prisma migration consistency
        run: |
          cd apps/api
          npx prisma migrate deploy
          npx prisma migrate diff \
            --from-config-datasource \
            --to-schema prisma/schema.prisma \
            --exit-code \
          || (echo "❌ Prisma schema and migrations are out of sync!" && echo "Run 'pnpm db:migrate:dev' to create a migration for pending changes." && exit 1)
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/qoomb_test

      - name: Generate JWT RS256 key pair for tests
        run: |
          openssl genpkey -algorithm RSA -out /tmp/jwt-private.pem -pkeyopt rsa_keygen_bits:2048
          openssl rsa -pubout -in /tmp/jwt-private.pem -out /tmp/jwt-public.pem
          echo "JWT_PRIVATE_KEY=$(base64 -w0 < /tmp/jwt-private.pem)" >> "$GITHUB_ENV"
          echo "JWT_PUBLIC_KEY=$(base64 -w0 < /tmp/jwt-public.pem)" >> "$GITHUB_ENV"
          rm /tmp/jwt-private.pem /tmp/jwt-public.pem

      - name: Run tests
        run: pnpm run test
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/qoomb_test
          REDIS_URL: redis://localhost:6379
          ENCRYPTION_KEY: dGVzdC1lbmNyeXB0aW9uLWtleS1mb3ItY2ktb25seQ==
          KEY_PROVIDER: environment
          NODE_ENV: test

      - name: Upload coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        if: always()
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
