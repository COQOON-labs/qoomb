# SBOM (Software Bill of Materials) Generation
# Generates CycloneDX SBOM and third-party license report
# Runs on releases and can be triggered manually

name: SBOM

on:
  release:
    types: [published]
  workflow_dispatch:
  # Also run weekly to keep license info current
  schedule:
    - cron: '0 8 * * 2' # Every Tuesday at 8:00 AM UTC

# Top-level: minimal permissions (read-only by default)
permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Job-level: only what's needed
    permissions:
      contents: write # Attach SBOM to releases
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Generate CycloneDX SBOM
      # --ignore-npm-errors: pnpm's node_modules layout causes `npm ls` to
      # report phantom missing/invalid packages. The SBOM is still accurate.
      - name: Generate CycloneDX SBOM
        run: |
          npx @cyclonedx/cyclonedx-npm --ignore-npm-errors --output-file sbom.json --output-format JSON
          npx @cyclonedx/cyclonedx-npm --ignore-npm-errors --output-file sbom.xml --output-format XML

      # Generate license report
      - name: Generate License Report
        run: |
          pnpm licenses list --json > licenses.json 2>/dev/null || echo '{}' > licenses.json
          pnpm licenses list > THIRD-PARTY-LICENSES.txt 2>/dev/null || echo 'No license information available' > THIRD-PARTY-LICENSES.txt

      # Upload SBOM as artifact
      - name: Upload SBOM Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sbom-${{ github.sha }}
          path: |
            sbom.json
            sbom.xml
            licenses.json
            THIRD-PARTY-LICENSES.txt
          retention-days: 90

      # Attach SBOM to release (if triggered by release)
      - name: Attach SBOM to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          files: |
            sbom.json
            sbom.xml
            THIRD-PARTY-LICENSES.txt
